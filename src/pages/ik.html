<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calculateur Indemnités Kilométriques 2024 - Barème Officiel</title>
    <meta
      name="description"
      content="Calculez vos indemnités kilométriques selon le barème fiscal officiel 2024. Simulation gratuite pour voiture et deux-roues, déduction fiscale optimisée."
    />
    <meta
      name="keywords"
      content="indemnités kilométriques 2024, barème fiscal, déduction kilométrique, frais de déplacement, impôts"
    />
  </head>
  <body class="bg-gray-50">
    <header class="bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-4">
          <a
            href="../index.html"
            class="text-primary-600 hover:text-primary-700 font-medium"
            >← Retour</a
          >
          <h1 class="text-2xl font-bold text-gray-900">
            Indemnités Kilométriques 2024
          </h1>
          <div></div>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <section class="mb-8">
        <div class="max-w-4xl mx-auto">
          <h2 class="text-3xl font-bold text-gray-900 mb-6">
            Calculateur d'indemnités kilométriques 2024
          </h2>
          <div class="prose prose-lg text-gray-600">
            <p>
              Les indemnités kilométriques permettent de déduire fiscalement les
              frais de déplacement professionnel. Notre calculateur utilise le
              barème officiel 2024 publié par l'administration fiscale pour
              calculer précisément vos indemnités selon la puissance de votre
              véhicule et le nombre de kilomètres parcourus. Le barème 2025
              prend en compte l'inflation et l'évolution des coûts de carburant.
              Que vous soyez salarié, profession libérale ou dirigeant
              d'entreprise, ces indemnités constituent un avantage fiscal non
              négligeable. Notre outil calcule automatiquement selon les
              tranches kilométriques : tarif dégressif jusqu'à 5 000 km, puis de
              5 001 à 20 000 km, et au-delà de 20 000 km annuels. Compatible
              voitures et deux-roues.
            </p>
          </div>
        </div>
      </section>

      <div id="ik-calculator"></div>

      <div class="my-12 text-center">
        <div class="bg-gray-100 border border-gray-200 rounded-lg p-8">
          <p class="text-gray-500 text-sm">Espace publicitaire</p>
        </div>
      </div>
    </main>

    <script type="module" src="../main.ts"></script>
    <script type="module">
      import { CalculatorFrame } from "../components/CalculatorFrame.ts";
      import { formatCurrency } from "../main.ts";
      import { baremes } from "../data/baremes.ts";

      const ikConfig = {
        title: "Calculateur d'indemnités kilométriques 2024",
        description: "Calculez vos indemnités selon le barème fiscal officiel.",
        fields: [
          {
            id: "type_vehicule",
            label: "Type de véhicule",
            type: "select",
            required: true,
            options: [
              { value: "voiture", label: "Voiture" },
              { value: "deux_roues", label: "Deux-roues" },
            ],
          },
          {
            id: "puissance",
            label: "Puissance fiscale (CV)",
            type: "select",
            required: true,
            options: [
              { value: "3CV et moins", label: "3 CV et moins" },
              { value: "4CV", label: "4 CV" },
              { value: "5CV", label: "5 CV" },
              { value: "6CV", label: "6 CV" },
              { value: "7CV et plus", label: "7 CV et plus" },
            ],
          },
          {
            id: "cylindree_moto",
            label: "Cylindrée (deux-roues)",
            type: "select",
            required: false,
            options: [
              { value: "moins_50cc", label: "Moins de 50cc" },
              { value: "50cc_125cc", label: "50cc à 125cc" },
              { value: "plus_125cc", label: "Plus de 125cc" },
            ],
          },
          {
            id: "kilometres",
            label: "Nombre de kilomètres annuels",
            type: "number",
            required: true,
            placeholder: "15000",
            min: 1,
            step: 1,
          },
        ],
        calculate: (values) => {
          try {
            const typeVehicule = values.type_vehicule;
            const kilometres = values.kilometres;

            let indemniteParKm = 0;
            let total = 0;

            if (typeVehicule === "voiture") {
              const puissance = values.puissance;
              const baremePuissance = baremes.indemnites_kilometriques.voiture[
                "2024"
              ].find((b) => b.puissance === puissance);

              if (!baremePuissance) {
                throw new Error("Puissance non trouvée");
              }

              // Calcul par tranches
              if (kilometres <= 5000) {
                total = kilometres * baremePuissance.jusqu_5000;
                indemniteParKm = baremePuissance.jusqu_5000;
              } else if (kilometres <= 20000) {
                total =
                  5000 * baremePuissance.jusqu_5000 +
                  (kilometres - 5000) * baremePuissance.de_5001_20000;
                indemniteParKm = total / kilometres;
              } else {
                total =
                  5000 * baremePuissance.jusqu_5000 +
                  15000 * baremePuissance.de_5001_20000 +
                  (kilometres - 20000) * baremePuissance.au_dela_20000;
                indemniteParKm = total / kilometres;
              }
            } else {
              const cylindree = values.cylindree_moto;
              indemniteParKm =
                baremes.indemnites_kilometriques.deux_roues[cylindree];
              total = kilometres * indemniteParKm;
            }

            return {
              success: true,
              data: {
                total,
                indemniteParKm,
                kilometres,
                typeVehicule,
                puissance: values.puissance,
                cylindree: values.cylindree_moto,
              },
            };
          } catch (error) {
            return {
              success: false,
              error: "Erreur lors du calcul. Vérifiez vos données.",
            };
          }
        },
        formatResult: (result) => {
          const data = result.data;
          return `
          <div class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="bg-blue-50 p-4 rounded-lg">
                <h4 class="font-semibold text-gray-800">Distance annuelle</h4>
                <p class="text-xl font-bold text-primary-600">${data.kilometres.toLocaleString()} km</p>
              </div>
              <div class="bg-green-50 p-4 rounded-lg">
                <h4 class="font-semibold text-gray-800">Indemnités totales</h4>
                <p class="text-xl font-bold text-green-600">${formatCurrency(
                  data.total
                )}</p>
              </div>
            </div>
            
            <div class="border-t pt-4">
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span>Type de véhicule :</span>
                  <span class="font-medium">${
                    data.typeVehicule === "voiture" ? "Voiture" : "Deux-roues"
                  }</span>
                </div>
                ${
                  data.puissance
                    ? `
                <div class="flex justify-between">
                  <span>Puissance fiscale :</span>
                  <span class="font-medium">${data.puissance}</span>
                </div>
                `
                    : ""
                }
                ${
                  data.cylindree
                    ? `
                <div class="flex justify-between">
                  <span>Cylindrée :</span>
                  <span class="font-medium">${data.cylindree.replace(
                    "_",
                    " "
                  )}</span>
                </div>
                `
                    : ""
                }
                <div class="flex justify-between">
                  <span>Indemnité moyenne par km :</span>
                  <span class="font-medium">${data.indemniteParKm.toFixed(
                    3
                  )} €</span>
                </div>
              </div>
            </div>

            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mt-4">
              <p class="text-sm text-orange-800">
                <strong>⚠️ Attention :</strong> Ce calculateur utilise le barème fiscal 2024 (derniers taux officiels publiés). 
                Les barèmes 2025 ne sont pas encore disponibles - ils sont généralement publiés entre mars et avril.
              </p>
            </div>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4">
              <p class="text-sm text-blue-800">
                <strong>À savoir :</strong> Ces indemnités sont déductibles fiscalement et doivent être 
                déclarées dans vos frais réels ou remboursées par votre employeur.
              </p>
            </div>
          </div>
        `;
        },
      };

      // Masquer/afficher les champs selon le type de véhicule
      document.addEventListener("DOMContentLoaded", () => {
        setTimeout(() => {
          const typeSelect = document.getElementById("type_vehicule");
          const puissanceDiv = document
            .getElementById("puissance")
            ?.closest("div");
          const cylindreeDiv = document
            .getElementById("cylindree_moto")
            ?.closest("div");

          function toggleFields() {
            const type = typeSelect?.value;
            if (puissanceDiv)
              puissanceDiv.style.display =
                type === "voiture" ? "block" : "none";
            if (cylindreeDiv)
              cylindreeDiv.style.display =
                type === "deux_roues" ? "block" : "none";
          }

          typeSelect?.addEventListener("change", toggleFields);
          toggleFields();
        }, 100);
      });

      new CalculatorFrame("ik-calculator", ikConfig);
    </script>

    <!-- Auto-initialisation des exports PDF/CSV -->
    <script type="module" src="../utils/pdfExport.js"></script>
    <script type="module" src="../utils/autoExportInit.js"></script>
  </body>
</html>
